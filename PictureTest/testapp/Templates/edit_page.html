{% extends 'main.html' %}
{% load static %}

{% block title %}
Edit Page
{% endblock %}

{% block content %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<div class="add-page-wrapper">
    <h2>New Page of {{test.name}}</h2>
    <!-- <div class="add-page-body"> -->
        <form class="add-page-body" action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="field-wrapper">
                <label for="number">Page Number</label>
                <input type="number" name="page_number" value="{{page.page_number}}" id="number">
                <!-- <select name="page_number" id="number" required>
                {% for number in available_page_numbers %}
                    <option value="{{ number }}">{{ number }}</option>
                {% endfor %}
                </select> -->
            </div>
            <div class="questions-group">
                {% for question in questions %}
                <div class="question-wrapper">
                    <input type="hidden" value="{{question.number}}" name="question_number" class="question-number">
                    <input type="hidden" name="sub_" class="sub_count"  value="0" disabled>
                    <input type="hidden" name="delete-image-template" id="" disabled>
                    
                    <div class="image-wrapper">
                        <div class="kk1">
                            <div class="image-preview">
                                {% for image in images %}
                                {% if image.question.id == question.id %}
                                <div class="preview-item kk23" id="preview-item-{{image.id}}">
                                    <img class="preview-image-static" src="{{ image.image.url }}" alt="Image Preview">
                                    <button type="button"
                                            class="image-delete-btn"
                                            title="Remove image"
                                            id="delete-btn-{{ image.id }}"
                                            onclick="createDeleteInput('{{ image.id }}', event, 'restore-btn-{{ image.id }}')">
                                        x
                                    </button>
                                    <!-- <button type="button"
                                            id="restore-btn-{{ image.id }}"
                                            class="res-img-btn"
                                            style="display: none;"
                                            onclick="restoreImage('{{ image.id }}', event, 'delete-btn-{{ image.id }}')">
                                        Restore
                                    </button> -->
                                </div>

                                {% endif %}
                                {% endfor %}
                            </div>
                            <div class="image-input-wrapper">
                                <input type="file" class="page-image page-image-hidden page-image-static" name="page_image_1" onchange="previewImage(event)" placeholder="New Image" id="{{image.image.url}}" accept="image/*" style="display: none;" disabled>
                            </div>
                        </div>
                        
                        <button type="button" class="image-button" id="image-button-{{question.number}}" onclick="addImage(event)">+</button>
                        <button type="button" class="delete-question-btn" title="Delete this question" onclick="openDeleteQuestionModal(event)">ðŸ—‘</button>
                        
                    </div>
                    <div class="question-item">
                        <div class="main-question">
                            <div class="field-wrapper">
                                <label for="question-1" class="qnumber">Question {{ question.number }}</label>
                                <!-- <input type="text" name="question_1" class="question" id="question-1"> -->
                                <!-- Main Question -->
                                <div class="quill-wrapper">
                                    <div id="editor-question-{{question.number}}" class="static-quill-editor quill-editor"></div>
                                    <textarea name="question" id="question-{{question.number}}" style="display: none;">{{ question.text|safe }}</textarea>
                                </div>                                
                            </div>
                        </div>
                        <div class="sub-questions">
                            {% for sub_question in sub_questions %}
                            {% if sub_question.question.id == question.id %}
                            <div class="field-wrapper">
                                <label for="sub"><span class="sub_label">
                                    {% if sub_question.number == 1 %} a
                                    {% elif sub_question.number == 2 %} b
                                    {% elif sub_question.number == 3 %} c
                                    {% elif sub_question.number == 4 %} d
                                    {% elif sub_question.number == 5 %} e
                                    {% elif sub_question.number == 6 %} f
                                    {% endif %}
                                </span></label>
                                <!-- Sub Question -->
                                    <div class="quill-wrapper">
                                            <div id="editor-sub-{{question.number}}-{{sub_question.number}}" class="static-quill-editor quill-editor"></div>
                                            <textarea name="sub_{{question.number}}"  class="sub-input" id="sub-{{question.number}}-{{sub_question.number}}" style="display: none;">{{ sub_question.text|safe }}</textarea>
                                        </div>
                                    <!-- static delete button for server-rendered subs -->
                                    <button type="button" class="delete-sub-btn static-delete-sub-btn" title="Delete sub-question">ðŸ—‘</button>
                                <!-- <input type="text" class="sub-input" name="sub_1" id="sub" disabled> -->
                            </div>
                            {% endif %}
                            {% endfor %}
                            <div class="field-wrapper sub-hidden" style="display: none;">
                                <label for="sub"><span class="sub_label">sub</span></label>
                                <!-- Sub Question -->
                                    <div class="quill-wrapper sub-hidden" style="display: none;">
                                        <div id="editor-sub-1" class="quill-editor"></div>
                                        <textarea name="sub_"  class="sub-input" id="sub-1" disabled  style="display: none;"></textarea>
                                    </div>
                                <!-- <input type="text" class="sub-input" name="sub_1" id="sub" disabled> -->
                            </div>
                            <div class="buttons">
                                <button type="button" onclick="createSub(event)">+ sub</button>
                            </div>
                        </div>
                        
                    </div>
                </div>
                {% endfor %}
                <div class="buttons2">
                    <button type="button" onclick="createQuestion(), displayAddQuestionButtons()">+ question</button>
                </div>
                <div class="question-wrapper-hidden question-wrapper" style="display: none;">
                    <input type="hidden" value="0" name="question_number" class="question-number" disabled>
                    <input type="hidden" name="sub_" class="sub_count" value="0" disabled>
                    <div class="image-wrapper">
                        <div class="image-preview">
                            <img class="preview-image" src="{% static 'images/ttt.jpg' %}" alt="Image Preview">
                        </div>
                        <div class="image-input-wrapper">
                            <!-- <label for="new-image">New Image</label> -->
                            <input type="file" class="page-image page-image-hidden" onchange="previewImage(event)" name="page_image_" placeholder="New Image" id="new-image" accept="image/*" style="display: none;" disabled>
                        </div>
                        <button type="button" class="image-button" onclick="addImage(event)">+</button>
                        <button type="button" class="delete-question-btn" title="Delete this question" onclick="openDeleteQuestionModal(event)">ðŸ—‘</button>
                    </div>
                    <div class="question-item">
                        <div class="main-question">
                            <div class="field-wrapper">
                                <label for="question" class="qnumber"></label>
                                <!-- <input type="text" class="question" name="question_" id="question"> -->
                                <div class="quill-wrapper">
                                    <div id="editor-question-template" class="quill-editor"></div>
                                    <textarea type="hidden" name="question" id="question-"  style="display: none;" disabled></textarea>
                                </div>   
                            </div>
                        </div>
                        <div class="sub-questions">
                            <div class="field-wrapper sub-hidden" style="display: none;">
                                <label for="sub" class="sub_label"></label>
                                <!-- <input type="text" class="sub sub-input" name="sub_" id="sub" disabled> -->
                                <div class="quill-wrapper sub-hidden" style="display: none;">
                                    <div id="editor-sub-template" class="quill-editor"></div>
                                    <textarea name="sub_" class="sub-input" id="sub-1" disabled  style="display: none;"></textarea>
                                </div>
                            </div>
                            <div class="buttons">
                                <button type="button" onclick="createSub(event)">+ sub</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="buttons">
                <button type="submit">Save</button>
                <button type="button" onclick="gotoPage(`{% url 'setup_pages_page' test.id %}`)">Cancel</button>
            </div>
        </form>
</div>

<div id="delete-question-modal" style="display: none;">
    <div class="inner">
        <input type="hidden" name="qnm2">
        <h2>Are You Sure?</h2>
        <p><strong>Task: </strong> Delete Question <span class="qnm"></span></p>
        <div class="buttons">
            <button type="button" onclick="deleteQuestion(), closeIt('delete-question-modal')">Yes</button>
            <button type="button" onclick="closeIt('delete-question-modal')">No</button>
        </div>
    </div>
</div>

<div id="delete-sub-modal" style="display:none;">
    <div class="inner">
        <h2>Are You Sure?</h2>
        <p>Delete this sub-question?</p>
        <div class="buttons">
            <button type="button" onclick="confirmDeleteSubQuestion()">Yes</button>
            <button type="button" onclick="document.getElementById('delete-sub-modal').style.display='none'">No</button>
        </div>
    </div>
</div>
        


<script>
    let questions_count = {{question_summary|safe}}
    console.log("qc", questions_count)
    questions_count.forEach(Element => {
        if(Element.active == "true") {
            Element.active = true;
        } else {
            Element.active = false;
        }
    })
    console.log("qq", questions_count)
    

    const quillInstances = {};
    const quillConfigs = {
  theme: 'snow',
  modules: {
    toolbar: [
      ['bold', 'italic', 'underline'],
      [{ 'script': 'sub'}, { 'script': 'super' }],
      [{ 'header': [1, 2, 3, false] }],
      ['clean']
    ]
  }
};

// Initialize static editors
window.addEventListener('DOMContentLoaded', () => {
  // Find all quill-editor divs
  const editors = document.querySelectorAll('.static-quill-editor');
  console.log(editors)

  editors.forEach((editor, index) => {
    // Ensure each editor has a unique ID
    const editorId = editor.id || `editor-${index}`;
    editor.id = editorId;

    // Find the corresponding hidden textarea (assumed to be the next sibling)
    const textarea = editor.parentElement.querySelector('textarea');
    const textareaId = textarea?.id || `textarea-${index}`;
    textarea.id = textareaId;

    // Initialize Quill
    const quill = new Quill(`#${editorId}`, quillConfigs);

    // Set initial content from textarea
    quill.root.innerHTML = textarea.value;

    // Sync on change
    quill.on('text-change', () => {
      textarea.value = quill.root.innerHTML;
    });

    // Store instance
    quillInstances[editorId] = quill;
  });    
});



    let undoList = [];
    let redoList = [];
    undoList.push("")
    
// Preview the uploaded image. Uses a data-preview-id on the input to find the correct image element.
const previewImage = ({target}) => {
    console.log("preview started")
    const file = target.files && target.files[0];

    // Prefer a linked preview via data attribute
    const previewId = target.dataset.previewId;
    let preview = null;
    if (previewId) {
        preview = document.querySelector(`[data-preview-id="${previewId}"]`);
    }

    // Fallback: find the first .preview-image within the same .image-wrapper
    if (!preview) {
        const wrapper = target.closest(".image-wrapper");
        if (wrapper) preview = wrapper.querySelector('.preview-image');
    }

    if (!preview) return;

    console.log("file: ", file)
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            // Hide the original static placeholder image (if it exists in this wrapper)
            const wrapper = target.closest('.image-wrapper');
            if (wrapper) {
                // find the first preview-image that is not the one we're updating
                const staticPreview = Array.from(wrapper.querySelectorAll('.preview-image')).find(img => img !== preview);
                if (staticPreview) staticPreview.style.display = 'none';
            }
            // If the input had a preview id, make sure its preview-item is shown
            if (previewId) {
                try { showLinkedPreview(previewId); } catch (e) { console.warn(e); }
            }
        }
        reader.readAsDataURL(file);
    } else {
        preview.src = "";
        preview.style.display = 'none';
    }
}

const createDeleteInput = (imageId, {target}, restoreBID) => {
    const wrapper = target.closest(".question-wrapper");
    const question_number = Number(wrapper.querySelector(".question-number").value)
    const inputTemplate = wrapper.querySelector("input[name='delete-image-template']").cloneNode(true);
    // const restoreButton = document.getElementById(restoreBID)
    const previewObj = document.getElementById(`preview-item-${imageId}`);
    previewObj.remove();
    inputTemplate.name = "delete-image";
    inputTemplate.value = imageId;
    inputTemplate.disabled = false;
    inputTemplate.id = "delete-image-" + imageId;
    inputTemplate.className = "delete-image-hidden";
    wrapper.prepend(inputTemplate);
    // target.style.display = "none";
    // restoreButton.style.display = "flex";

    let current_question = questions_count.find(q => q.number = question_number);
    questions_count[current_question.index].image_count -= 1;
    document.getElementById(`image-button-${current_question.number}`).style.display = "block";
}

const restoreImage = (imageId, {target}, delBID) => {
    const inputElement = document.getElementById(`delete-image-${imageId}`);
    const delButton = document.getElementById(delBID)
    inputElement.remove();
    target.style.display = "none";
    delButton.style.display = "flex";

}

const displayAddQuestionButtons = () => {
    // Set Add question button visibility based on max questions
    const addQuestionBtn = document.querySelector('.buttons2');
    const activeQuestions = questions_count.filter(q => q.active);
    addQuestionBtn.style.display = activeQuestions.length >= 3 ? 'none' : 'flex';
}

window.onload = function() {
    questions_count.forEach(question => {
        let button = document.getElementById(`image-button-${question.number}`);
        if (button) {
            if(question.image_count === 2) {
                button.style.display = "none";
            } else {
                button.style.display = "block";
            }
        }
        
    })
    displayAddQuestionButtons()
}

// Preview the question text
// document.getElementById('page-question').addEventListener('input', function(event) {
//     const previewQ = document.getElementById('preview-question');
//     previewQ.textContent = event.target.value || 'No question added yet.';
// });

// window.addEventListener('DOMContentLoaded', () => {
//   const targets = document.querySelectorAll(".page-image-static");
//   console.log("targets", targets);

//   targets.forEach(target => {
//     const imageUrl = target.getAttribute("value") || target.getAttribute("id"); // fallback if value isn't set
//     if (!imageUrl) return;

//     // Prefer a linked preview via data attribute
//     const previewId = target.dataset.previewId;
//     console.log("pp",previewId)
//     let preview = null;
//     if (previewId) {
//       preview = document.querySelector(`[data-preview-id="${previewId}"]`);
//     }

//     // Fallback: find the first .preview-image within the same .image-wrapper
//     if (!preview) {
//       const wrapper = target.closest(".image-wrapper");
//       if (wrapper) preview = wrapper.querySelector('.preview-image');
//     }

//     if (!preview) return;

//     // Set the preview image from server URL
//     preview.src = imageUrl;
//     preview.style.display = 'block';

//     // Optionally hide any placeholder image
//     const wrapper = target.closest('.image-wrapper');
//     if (wrapper) {
//       const staticPreview = Array.from(wrapper.querySelectorAll('.preview-image')).find(img => img !== preview);
//       if (staticPreview) staticPreview.style.display = 'none';
//     }

//     // If the input had a preview id, make sure its preview-item is shown
//     if (previewId) {
//       try { showLinkedPreview(previewId); } catch (e) { console.warn(e); }
//     }
//   });
// });




// Delete a question and update questions_count
// function deleteQuestion(event) {
//     const btn = event.target.closest('.delete-question-btn');
//     const questionWrapper = btn.closest('.question-wrapper');
//     if (!questionWrapper) return;
//     // Get the question number from the hidden input
//     const qNumInput = questionWrapper.querySelector('.question-number');
//     if (!qNumInput) return;
//     const qNum = Number(qNumInput.value);
//     // Remove the question DOM node
//     questionWrapper.parentNode.removeChild(questionWrapper);
//     // Update questions_count
//     const qObj = questions_count.find(q => q.number === qNum);
//     if (qObj) {
//         qObj.active = false;
//         qObj.sub_level = 0;
//         qObj.image_count = 0;
//     }
//     // Renumber remaining question-wrappers and update their inputs/labels
//     const mainNode = document.querySelector('.questions-group');
//     const wrappers = Array.from(mainNode.querySelectorAll('.question-wrapper')).filter(w => w.style.display !== 'none');
//     wrappers.forEach((w, idx) => {
//         // Update hidden input value
//         const qNumInput = w.querySelector('.question-number');
//         if (qNumInput) qNumInput.value = idx + 1;
//         // Update label text
//         const label = w.querySelector('.qnumber');
//         if (label) label.textContent = 'Question ' + (idx + 1);
//         // Update name attributes for main question and sub inputs
//         const mainQ = w.querySelector('.question');
//         if (mainQ) mainQ.name = 'question_' + (idx + 1);
//         const subQ = w.querySelector('.sub');
//         if (subQ) subQ.name = 'sub_' + (idx + 1);
//         // Update image input name
//         const imgInput = w.querySelector('.page-image');
//         if (imgInput) imgInput.name = 'page_image_' + (idx + 1);
//     });
//     // Optionally, show the "+ question" button if it was hidden
//     const btns2 = mainNode && mainNode.querySelector('.buttons2');
//     if (btns2) btns2.style.display = 'flex';
// }


</script>

<style>
/* Delete question button styling */
.delete-question-btn {
    background: #e57373;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 1.2rem;
    margin-left: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(229,115,115,0.15);
    transition: background 0.2s, transform 0.1s;
}
.delete-question-btn:hover {
    background: #c62828;
    transform: scale(1.08);
}
.quill-editor {
  word-wrap: break-word;
  overflow-wrap: break-word;
  white-space: normal;
}

.ql-editor {
  word-wrap: break-word;
  overflow-wrap: break-word;
  white-space: pre-wrap; /* preserves line breaks */
  max-width: 100%;
  box-sizing: border-box;
}

.image-links {
    display: flex; 
    flex-direction: column; 
    gap: 5px;
}

.del-image-btn {
    border-radius: 50%;
    padding: 5px;
    border: none;
    background-color: #e57373;
}
.res-img-btn {
    border-radius: 10px;
    padding: 5px;
    border: none;
    background-color: lightblue;
}
.image-delete-btn {
    color: #fff;
    background-color: #e57373;
    border-radius: 5px;
    border: none;
    width: 20px;
    margin-top: 5px;
}
.kk23 {
    display: flex;
    flex-direction: column;
}
.question-wrapper {
    position: relative;
}

.delete-question-btn {
    position: absolute;
    right: 5px;
    top: 5px;
}

#delete-question-modal, #delete-sub-modal{
    width: 100vw;
    height: 100vh;
    position: fixed;
    left: 0;
    right: 0;
    background-color: #fff;
    flex-direction: column;
    justify-content: center;

    .inner {
        margin-left: auto;
        margin-right: auto;
    }
}

/* delete sub button */
.delete-sub-btn {
    margin-left: 8px;
    background: #e57373;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(229,115,115,0.15);
}
.delete-sub-btn:hover { background: #c62828; transform: scale(1.06); }

/* Add to your styles.css */
</style>
{% endblock %}